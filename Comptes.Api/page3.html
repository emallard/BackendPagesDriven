<html>

<head>
    <meta charset="UTF8">
    <link rel="stylesheet" href="/bootstrap.min.css">
    <link rel="stylesheet" href="/jquery.dataTables.min.css">

</head>

<body>

    <script src="/jquery-3.3.1.js"></script>
    <script src="/jquery.dataTables.min.js"></script>
    <script src="/render.js"></script>
    <script src="/renderSpecific.js"></script>
    <!--
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Navbar</a>
    </nav>
    -->
    <div class="container">
        <div id='pagename'></div>
        <div id='content'></div>
        <div id='bindings' style="font-size: 12px"></div>


        <script>
            var _page = null;


            async function init() {
                let myHeaders = new Headers();
                //myHeaders.append('Content-Type', 'application/json');
                let pageGet = '/api' + document.location.pathname + document.location.search;//document.location.href.replace('/pages', '/api');
                let response = await fetch(pageGet,
                    {
                        headers: myHeaders,
                        method: 'GET'
                    });

                let txt = await response.text();
                _page = JSON.parse(txt);
                console.log(_page);

                let pageTypeName = _page.PageTypeName;
                pageTypeName = pageTypeName.substring(pageTypeName.lastIndexOf('.') + 1);
                document.getElementById('pagename').innerHTML = `<b>${pageTypeName}</b>`;


                let _page2 = {};
                for (let k of Object.keys(_page)) {
                    if (k != 'PageQuery' && k != 'Bindings' && k != 'Inits' && k != 'PageTypeName')
                        _page2[k] = _page[k];
                }
                renderTo(_page2, pageTypeName, document.getElementById('content'));

                let htmlBindings = '';
                htmlBindings += _page.Inits.map(b => "Init : " + b.From.join('.') + ' =&gt; ' + b.To.join('.')).join('<br/>');
                htmlBindings += _page.Bindings.map(b => "Bind : " + b.From.join('.') + ' =&gt; ' + b.To.join('.')).join('<br/>');
                document.getElementById('bindings').innerHTML = htmlBindings;

            }

            init();

            async function call(callObj) {
                let myHeaders = new Headers();
                myHeaders.append('Content-Type', 'application/json');
                let response = await fetch('/api/call',
                    {
                        headers: myHeaders,
                        method: 'POST',
                        body: JSON.stringify(callObj)
                    });

                //let contentType = response.headers.get('Content-Type');
                //console.log('contentType ' + contentType)
                return await response.json();
            }

            async function formCall(callObj) {
                let response = await call(callObj);
                console.log(response);

                if (response['href'] != null) {
                    console.log('redirect to : ' + response['href']);
                    document.location.href = response['href'].replace('/api', '');
                }
            }

            function applyInits() {
                console.log('applyInits');
                for (let init of _page.Inits) {
                    let v = getValue(_page, init.From);
                    setValue(_page, init.To, v);
                }
            }

            function getValue(x, members) {
                console.log(' get ' + members.join('.'));
                let y = x;
                for (let i = 0; i < members.length; ++i)
                    y = y[members[i]];

                console.log(' value = ' + y);
                return y;
            }

            function setValue(x, members, value) {
                console.log(' set ' + members.join('.') + ' = ' + value);

                let y = x;
                for (let i = 0; i < members.length - 1; ++i)
                    y = y[members[i]];
                y[members.length - 1] = value;
            }
        </script>
</body>

</html>