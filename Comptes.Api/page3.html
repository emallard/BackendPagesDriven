<html>

<head>
    <meta charset="UTF8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="render.js"></script>
</head>

<body>
    <!--
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Navbar</a>
    </nav>
    -->
    <div class="container">
        <div id='content'>

        </div>
    </div>

    <script>
        var _page = null;


        async function init() {
            let myHeaders = new Headers();
            //myHeaders.append('Content-Type', 'application/json');
            let pageGet = '/api' + document.location.pathname + document.location.search;//document.location.href.replace('/pages', '/api');
            let response = await fetch(pageGet,
                {
                    headers: myHeaders,
                    method: 'GET'
                });

            let txt = await response.text();
            _page = JSON.parse(txt);
            console.log(_page);


            let pageType = _page.PageType.substring(0, _page.PageType.indexOf(",")).replace(/[.]/g, '-');
            pageTypeName = pageType.substring(pageType.lastIndexOf('-') + 1);

            let html = render(_page, pageTypeName);
            document.getElementById('content').innerHTML = html;
            document.getElementById('content').classList.add(pageTypeName);
            document.getElementById('content').classList.add(pageType);

            //registerOnSubmits();
            callAsyncCalls();
        }

        init();

        async function call(callObj) {
            let myHeaders = new Headers();
            myHeaders.append('Content-Type', 'application/json');
            let response = await fetch('/api/call',
                {
                    headers: myHeaders,
                    method: 'POST',
                    body: JSON.stringify(callObj)
                });

            //let contentType = response.headers.get('Content-Type');
            //console.log('contentType ' + contentType)
            return await response.json();
        }

        async function formCall(callObj) {
            let response = await call(callObj);
            console.log(response);

            if (response['href'] != null) {
                console.log('redirect to : ' + response['href']);
                document.location.href = response['href'].replace('/api', '');
            }
        }

        let asyncCalls = [];
        function addAsyncCall(x, h) {
            asyncCalls.push({ x: x, h: h });
        }

        async function callAsyncCalls() {
            for (let a of asyncCalls) {
                let response = await call(a.x);
                a.x.Result = response;
                document.getElementsByClassName(a.h)[0].innerHTML += render(response, a.h);
            }
        }

        let forms = [];
        function addForm(x, h) {
            forms.push({ x: x, h: h });
        }

        function registerOnSubmits() {
            for (let f of forms) {
                registerOnSubmit(f.x, f.h);
            }
        }

        function registerOnSubmit(form, idForm) {
            console.log('register on submit ' + idForm);
            document.getElementsByClassName(idForm)[0].addEventListener('submit', (evt) => {
                //alert('a');
                evt.preventDefault();

                let keys = Object.keys(form.Command);
                for (let k of keys) {
                    form.Command[k] = document.getElementById(k).value;
                }

                console.log('submit ' + idForm);
                formCall(form);
                return false;
            });

        }

    </script>
</body>

</html>